---
title: "Merging Datasets in R Tutorial"
author: "Tom Jeon"
date: "Sept 29, 2018"
output:
  html_document:
    self_contained: false
header-includes:
- \usepackage{booktabs}
---

```{r, include=FALSE}
tutorial::go_interactive()
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Merging Datasets in R Tutorial

### In this tutorial, you'll learn to join multiple data sets in R!

In the applied setting, data are hosted on different servers and exist in many different files. When the data you need come from multiple sources, it's essential to know how to aggregate them so that you lose as little information as possible and make pairings that actually make sense given the structure of your data.

This tutorial will walk you through:

- Merging data sets horizontally and vertically
- What keys are and how they add structure to your data
- Different types of joins (e.g. left-join, inner-join, full-join) and how to choose among them
- Common problems to watch out for and how to resolve them

When you're done, be sure to check out the [Joining Data in R with dplyr](https://www.datacamp.com/courses/joining-data-in-r-with-dplyr) course taught by Garrett Grolemund of RStudio. The first chapter is free. Garrett's course will go much more in-depth than this tutorial, covering advanced techniques to augment columns from one data set with columns from another with mutating joins, how to filter one data set against another with filtering joins, and how to sift through data sets with set operations. Along the way, you'll discover the best practices for building data sets and troubleshooting joins with `dplyr`.

## Concatenating data sets

At the high level, there are two ways you can merge data sets together; you can either concatenate more rows or concatenate more columnns to an existing data set by taking information from another data set. In general, when you have data sets that have the same set of columns or have the same set of observations, you can concatenate them vertically or horizontally, respectively.

### Adding data sets vertically

When you have multiple data sets that have the same set of columns, you can concatenate one data set to another vertically. That is, _keeping the columns_ of your data set, you can _add more rows_ to it. Having such information in one file will make it easier for you to aggregate and see the bigger picture without the hassle of switching back and forth between multiple files and tracking them.

Dataset1
```

```

Dataset2
```

```

It's important to note that if you have the same observation across multiple data sets and you concatenate them vertically using `rbind()`, you'll end up with duplicate observations in your table. And though the two data sets must have the same set of variables (i.e. columns), they don't have to be in the same order.

### Adding data sets horizontally

When you have data sets representing the same set of observations, you can concatentate such data sets horizontally. This time, _keeping the rows_ of your data set, you can _add more columns_ to it. In such cases, you should check that the order of the observations are the same. If your data sets have different number of rows, or they have the same number of rows but the rows are ordered inconsistently, you can pair one set of columns with the other set in a way that doesn't make sense. For example, consider the following:

```{r, echo=FALSE, results='asis'}
library(knitr)
library(xtable)
models <- kable(data.frame(make = c("Honda", "BMW", "Ford", "Tesla"),
                           models = c(63, 10, 26, 4)),
                format = "latex",
                booktabs = TRUE)
sales <- kable(data.frame(make = c("Ford", "BMW", "Honda", "Tesla"),
                          sales = c(119157, 25908, 188328, 29975)),
               format = "latex",
               booktabs = TRUE)

cat(c("\\begin{table}[!htb]
    \\begin{minipage}{.5\\linewidth}
      \\caption{}
      \\centering",
    models,
    "\\end{minipage}%
    \\begin{minipage}{.5\\linewidth}
      \\centering
        \\caption{}",
    sales,
    "\\end{minipage} 
\\end{table}"
))  
```

Let's extend the example you saw above. Suppose you have two data files, one containing name and gender, and another containing names and shirt sizes.

Combined Dataset1, Dataset2
```

```

Dataset3
```

```

Good work! But what if you had information only on some of the rows in one data set and wanted to add information only for those you have more information on? Put another way, what if you wanted to add more columns from one data set to another but these data sets don't have the same number of observations?

## Primary key and foreign keys

The first step when looking to combine data sets is to look for the *primary key* of your data set. The primary key is the column or set of columns that uniquely identifies each observation in your data set.


## Types of joins

There are Let `dat1` be the first data set and `dat2` the data set you're trying to join with `dat1`.

**Left joins**: return all rows from x, and all columns from x and y. Rows in x with no match in y will have NA values in the new columns. If there are multiple matches between x and y, all combinations of the matches are returned.

**Inner joins**: return all rows from x where there are matching values in y, and all columns from x and y. If there are multiple matches between x and y, all combination of the matches are returned.

**Full joins**: return all rows and all columns from both x and y. Where there are not matching values, returns NA for the one missing.


The joins mentioned above are examples of mutating joins since they combine variables from two data sets. Rows of the first data set that are not contained in the other are automatically dropped  are more! You can augment columns from one data set with columns from another with mutating joins, filter one data set against another with filtering joins, and sift through data sets with set operations. You can get hands-on practice implementing the best ways to combine data sets into single tables in the [Joining Data in R](https://www.datacamp.com/courses/joining-data-in-r-with-dplyr) course. Afterwards, youâ€™ll be well on your way to data manipulation mastery!

## Missing keys
Suppose we have two datasets. The first dataset is called `shirt` and contains the names of people and their shirt size:

```
> shirt
name size
1  Tom    M
2  Dan   XL
3 Keil    S
```

The second data set is called `noNames` and contains the people's surnnames, color preferences, but stores some information in the `row.names` attribute:

```
> noNames
surname color
Tom     Jeon  <NA>
Dan    Smith  Dark
Bob McLadden Light
```

Notice what could go wrong here? Two-table joins can get complicated when there are missing keys or duplicate keys. In this example, R's data frames store important information in the `row.names` attribute. When this is the case, you won't be able to access the key with a join function, as join functions can only access columns of the data frame.

The trick to easily fix this problem is to use `rownames_to_column()` from the `tibble` package. It returns a copy of your data set with the row names added to the data as a column. The first argument to `rownames_to_column()` is your data frame object and the second argument is a string specifying the name of the column you want to add.

Try exploring in the console below. Data sets `noNames` and `plays` are pre-loaded on your workspace.

```{r ex="create_c", type="pre-exercise-code"}
noNames <- data.frame(surname = c("Jeon", "Smith", "McLadden"), color = c(NA, "Dark", "Light"))
row.names(noNames) <- c("Tom", "Dan", "Bob")
shirt <- data.frame(name = c("Tom", "Dan", "Keil"), size = c("M", "XL", "S"))
```

```{r ex="create_c", type="sample-code"}
# Explore here!

```

## Final thoughts

In the real world, data comes split across many data sets, but R is designed to work with single tables of data. Manipulating and combining data sets are essential skills. You can try the first chapters of [Data Manipulation in R with dplyr](https://www.datacamp.com/courses/dplyr-data-manipulation-r-tutorial/) and  [Joining Data in R with dplyr](https://www.datacamp.com/courses/joining-data-in-r-with-dplyr) for free.
